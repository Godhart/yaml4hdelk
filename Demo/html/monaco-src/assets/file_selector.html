<!DOCTYPE html>
<!-- Inspired with https://codepen.io/aardrian/pen/VoQbLm, https://adrianroselli.com/2019/09/table-with-expando-rows.html -->
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Test for file browser</title>
    <link href="dark.css" rel="stylesheet">
    <script type="text/javascript" src="./browser.js"></script>
</head>

<body class="tool" style="margin:0;padding:0">

    <script>
        // Populate test data
        // NOTE: this date produces longest text and is used to set size for node-info column
        const special_date = new Date()
        special_date.setFullYear(2022)
        special_date.setMonth(11)
        special_date.setDate(30)
        special_date.setHours(22)
        special_date.setMinutes(59)
        special_date.setSeconds(59)

        const filez = {
            "/file1": { "added": true, "timestamp": special_date.getTime() },
            "/folder0/file0-1": { "timestamp": special_date.getTime() - 60 },
            "/folder1/file1-1": { "modified": true, "fav": true, "timestamp": special_date.getTime() - 60 },
            "/folder1/file1-2": { "removed": true, "timestamp": special_date.getTime() - 120 },
            "/folder1/file1-3": { "renamed": true, "timestamp": special_date.getTime() - 240 },
            "/folder1/sub1/file1-1-1": { "timestamp": special_date.getTime() - 60 },
            "/folder1/sub2/file1-2-1": { "added": true, "fav": true, "timestamp": special_date.getTime() - 120 },
            "/folder2/file2-1": { "locked": true, "timestamp": special_date.getTime() - 300 },
            "/folder2/file2-2": { "flocked": true, "timestamp": special_date.getTime() - 360 },
            "/folder2/file2-3": { "locked": true, "modified": true, "outdate": true, "timestamp": special_date.getTime() },
            "/folder3/file3-1": { "added": true, "errors": ["Some error"], "timestamp": special_date.getTime() - 60 },
            "/folder3/file3-2": { "locked": true, "removed": true, "timestamp": special_date.getTime() - 120 },
            "/folder3/file3-2": { "flocked": true, "modified": true, "timestamp": special_date.getTime() - 120 },
            "/folder3/file3-3": { "locked": true, "modified": true, "open": true, "timestamp": special_date.getTime() - 240 },
            "/folder3/sub1/file3-1-1": { "open": true, "timestamp": special_date.getTime() - 60 },
            "/folder3/sub2/file3-2-1": { "fav": true, "timestamp": special_date.getTime() - 120 },
            "/folder4/file1-1": { "timestamp": special_date.getTime() - 300 },
            "/folder4/file1-2": { "errors": ["Error 1-2 1"], "timestamp": special_date.getTime() - 360 },
            "/folder4/file1-3": { "errors": ["Error 1-3 1", "Error 1-3 2"], "timestamp": special_date.getTime() - 360 },
            "/folder4/file1-4": { "timestamp": special_date.getTime() - 360 },
            "/folder4/file1-5": { "timestamp": special_date.getTime() - 360 },
            "/folder4/file1-6": { "timestamp": special_date.getTime() - 360 },
            "/folder4/sub1/file4-1-1": { "errors": ["Error 4-1-1 1"], "timestamp": special_date.getTime() - 60 },
            "/folder4/sub1/file4-1-2": { "errors": ["Error 4-1-1 2"], "timestamp": special_date.getTime() - 120 },
            "/folder4/sub1/file4-1-3-with-a-long-long-long-long-long-name": { "timestamp": special_date.getTime() - 120 },
        }

        function getPath(el) {
           // Helper to get associated file/folder path for HTML element
           // If data-path is not set on element, then check parent and so on
            while (true) {
                let path = el.getAttribute("data-path")
                if (path !== null) {
                    return path
                }
                if (el.parentNode === undefined && el.parentNode === null) {
                    break
                }
                el = el.parentNode
            }
            return null
        }

        // Feedback on user interaction
        class UI_Feedback {
            toggleFolder = function (el) {
                const path = getPath(el)
                browser.toggleFolder(path)
            }

            toggleFolderFilter = function (el) {
                const path = getPath(el)
                browser.toggleFolderFilter(path)
            }

            toggleFav = function (el) {
                const path = getPath(el)
                alert("toggleFav:" + path)
            }

            toggleTab = function (el) {
                const path = getPath(el)
                alert("toggleTab:" + path)
            }

            focusTab = function (el) {
                const path = getPath(el)
                alert("focusTab:" + path)
            }

            saveChanges = function (el) {
                const path = getPath(el)
                alert("saveChanges:" + path)
            }

            resetChanges = function (el) {
                const path = getPath(el)
                alert("resetChanges:" + path)
            }

            addNode = function (el) {
                const path = getPath(el)
                alert("addNode:" + path)
            }

            renameNode = function (el) {
                const path = getPath(el)
                alert("renameNode:" + path)
            }

            deleteNode = function (el) {
                const path = getPath(el)
                alert("deleteNode:" + path)
            }

            reloadNode = function (el) {
                const path = getPath(el)
                alert("reloadNode:" + path)
            }

            lockNode = function (el) {
                const path = getPath(el)
                alert("lockNode:" + path)
            }

            favNode = function (el) {
                const path = getPath(el)
                alert("favNode:" + path)
            }

            showNodeErrors = function (el) {
                const path = getPath(el)
                alert("showNodeErrors:" + path)
            }

            openNodeLink = function (el) {
                const path = getPath(el)
                alert("openNodeLink:" + path)
            }
        }

        function createOption(selector, text, value) {
            let opt = document.createElement("option");
            opt.value = value;
            opt.text = text;
            selector.options.add(opt);
        }

        function onFilterPathChange(value) {
            browser.updatePathFilter(value)
        }
    </script>

    <div id="domainsSelector">
        Data domain: <select id="domains" class="tool" onchange="console.log(this.value)"></select>
    </div>
    <div>
        View: <button class="tool b-t" onclick="this.innerHTML = browser.toggleView()">tiny</button>
    </div>

    <div id="filesBrowserPlaceholder">
        <table class="tool tool-compact tool-tiny" id="filesBrowser">
            <thead>
                <tr id="filtersRow" data-path="all" data-folder-expanded="false" data-filter-changed="false"
                    data-dont-display-folders="false" data-filter-open="false" data-filter-locked="false"
                    data-filter-flocked="false" data-filter-outdate="false" data-filter-union="true"
                    data-filter-fav="false" data-filter-errors="false">
                    <th style="width: 34px;">
                        <button id="but-collapse" title="Expand All" class="tool-icon f-theme tool-icon-folder"
                            onclick="browser.toggleAllFolder()"></button>
                    </th>
                    <th>
                        <!-- TODO: fill-in with static path like shown below
                        <button class="tool b-but tool-folder-static-path">/folder1</button>
                        <button class="tool b-but tool-folder-static-path">/sub1</button>
                        -->
                        <div style="width: 100%; display:flex; flex-direction:row;">
                            <input id="filePathFilter" title="File path filter" class="tool"
                                style="width: 100%; flex:1;" value="" onchange="onFilterPathChange(this.value)"
                                onkeyup="onFilterPathChange(this.value)"
                                onkeypress="if (event.keyCode == 13) {return false}"></input>
                            <span style="width: 4px">&nbsp;</span>
                            <button id="but-dontDisaplyFolders" title="Don't display folders" style="width: 26px;"
                                class="tool-icon tool-dont-display-folders"
                                onclick="browser.toggleFilter('folders', 'data-dont-display-folders')">&#128448;</button>
                            <span style="width: 4px">&nbsp;</span>
                            <button id="but-filterOpen" title="Display open files"
                                class="tool-icon tool-filter-open-color"
                                onclick="browser.toggleFilter('open', 'data-filter-open')">&#128441;</button>
                        </div>
                    </th>
                    <th style="width: 34px">
                        <button id="but-filterChanged" title="Display changed files"
                            class="tool bf-t tool-filter-changed-color"
                            onclick="browser.toggleFilter('changed', 'data-filter-changed')">&#9679;</button>
                    </th>
                    <th style="width: 180px">
                        <!-- TODO: HidePath in names:   Path\ -->
                        <!-- TODO: SortByName: A-z z-A -->
                        <!-- TODO: SortByDate: &#128467; &#8645; &#8613; &#8615; -->
                        <button id="but-filterLocked" title="Display locked files"
                            class="tool-icon tool-filter-locked-color"
                            onclick="browser.toggleFilter('locked', 'data-filter-locked')">&#9919;</button>
                        <button id="but-filterFlocked" title="Display files locked by someone else"
                            class="tool-icon tool-filter-flocked-color"
                            onclick="browser.toggleFilter('flocked', 'data-filter-flocked')">&#9919;</button>
                        <button id="but-filterOutdate" title="Display outdated files"
                            class="tool-icon tool-filter-outdate-color"
                            onclick="browser.toggleFilter('outdate', 'data-filter-outdate')">&#10226;</button>
                        <button id="but-filterUnion" title="Join filtered" class="tool-icon tool-filter-union-color"
                            onclick="browser.toggleFilter('union', 'data-filter-union')">&#10756;</button>
                    </th>
                    <th style="width: 20px">
                        <button id="but-filterStarred" title="Display starred files"
                            class="tool-icon tool-filter-fav-color"
                            onclick="browser.toggleFilter('fav', 'data-filter-fav')">&#9733;</button>
                    </th>
                    <th style="width: 20px">
                        <button id="but-filterErrors" title="Display errors" class="tool-icon tool-filter-errors-color"
                            onclick="browser.toggleFilter('errors', 'data-filter-errors')">&#9888;</button>
                    </th>
                    <th>
                        <select id="viewer" title="Tool to draw schematic" class="tool"
                            onchange="console.log(this.value)">
                            <option>HDELK</option>
                            <option>D3HW</option>
                        </select>
                    </th>
                </tr>
            </thead>
            <tbody id="filesList">
            </tbody>
        </table>
    </div>

    <script>
        ["demo", "test"].forEach(item => {
            createOption(document.getElementById("domains"), item, item)
        })

        document.getElementById("domains").value = "test"

        const uiFeedback = new UI_Feedback()

        const browser = new Browser(
            filez,
            {"locked": undefined, "flocked": undefined, "outdate": undefined},
            "tiny",
            "uiFeedback"
        )

        browser.populate(document.getElementById("filesBrowser"))
        browser.update()
        browser.toggleView(browser.view)
    </script>

</body>

</html>
