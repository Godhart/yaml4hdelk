<!DOCTYPE html>
<!-- Inspired with https://codepen.io/aardrian/pen/VoQbLm, https://adrianroselli.com/2019/09/table-with-expando-rows.html -->
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Test for file browser</title>
    <link href="dark.css" rel="stylesheet">
</head>

<body class="tool">

    <script>
        const Add = "&#128932;"
        const Eye = "&#128065;"
        const Star = "&#9733;"
        const Pencil = "&#128393;"
        const Lock = "&#9919;"
        const CollapsedFolder = "&#128448;"
        const ExpandedFolder = "&#128449;"
        const Save = "&#128427;"
        const Delete = "&#10005;"
        const Reset = "&#9100;"
        const Warning = "&#9888;"
        const Stop = "&#11203;"
        const Reload = "&#10226;"
        const DocText = "&#128441;"
        const DocPic = "&#128443;"
        const Circle = "&#9679;"
        const Link = "&#11179;"

        // Populate table
        const filez = {
            "/file1": { "added": true, "timestamp": new Date().getTime() },
            "/folder0/file0-1": { "timestamp": new Date().getTime() - 60 },
            "/folder1/file1-1": { "modified": true, "fav": true, "timestamp": new Date().getTime() - 60 },
            "/folder1/file1-2": { "removed": true, "timestamp": new Date().getTime() - 120 },
            "/folder1/file1-3": { "renamed": true, "timestamp": new Date().getTime() - 240 },
            "/folder1/sub1/file1-1-1": { "timestamp": new Date().getTime() - 60 },
            "/folder1/sub2/file1-2-1": { "added": true, "fav": true, "timestamp": new Date().getTime() - 120 },
            "/folder2/file2-1": { "locked": true, "timestamp": new Date().getTime() - 300 },
            "/folder2/file2-2": { "flocked": true, "timestamp": new Date().getTime() - 360 },
            "/folder2/file2-3": { "locked": true, "modified": true, "outdate": true, "timestamp": new Date().getTime() },
            "/folder3/file3-1": { "added": true, "errors": ["Some error"], "timestamp": new Date().getTime() - 60 },
            "/folder3/file3-2": { "locked": true, "removed": true, "timestamp": new Date().getTime() - 120 },
            "/folder3/file3-2": { "flocked": true, "modified": true, "timestamp": new Date().getTime() - 120 },
            "/folder3/file3-3": { "locked": true, "modified": true, "open": true, "timestamp": new Date().getTime() - 240 },
            "/folder3/sub1/file3-1-1": { "open": true, "timestamp": new Date().getTime() - 60 },
            "/folder3/sub2/file3-2-1": { "fav": true, "timestamp": new Date().getTime() - 120 },
            "/folder4/file1-1": { "timestamp": new Date().getTime() - 300 },
            "/folder4/file1-2": { "timestamp": new Date().getTime() - 360 },
            "/folder4/file1-3": { "timestamp": new Date().getTime() - 360 },
            "/folder4/file1-4": { "timestamp": new Date().getTime() - 360 },
            "/folder4/file1-5": { "timestamp": new Date().getTime() - 360 },
            "/folder4/file1-6": { "timestamp": new Date().getTime() - 360 },
        }

        const folders = {}    // NOTE: folders are populated during table population
        const filesFilter = {
            "path": "",
            "lock": undefined,
            "changed": undefined,
            "open": undefined,
            "fav": undefined,
            "outdate": undefined,
            "errors": undefined,
            "critical": undefined
        }

        function getPath(el) {
            while (true) {
                let path = el.getAttribute("data-path")
                if (path !== null) {
                    return path
                }
                if (el.parentNode === undefined && el.parentNode === null) {
                    break
                }
                el = el.parentNode
            }
            return null
        }

        function toggleFav(el) {
            const path = getPath(el)
            alert("toggleFav:" + path)
        }

        function toggleTab(el) {
            const path = getPath(el)
            alert("toggleTab:" + path)
        }

        function focusTab(el) {
            const path = getPath(el)
            alert("focusTab:" + path)
        }

        function saveChanges(el) {
            const path = getPath(el)
            alert("saveChanges:" + path)
        }

        function resetChanges(el) {
            const path = getPath(el)
            alert("resetChanges:" + path)
        }

        function addNode(el) {
            const path = getPath(el)
            alert("addNode:" + path)
        }

        function renameNode(el) {
            const path = getPath(el)
            alert("renameNode:" + path)
        }

        function deleteNode(el) {
            const path = getPath(el)
            alert("deleteNode:" + path)
        }

        function reloadNode(el) {
            const path = getPath(el)
            alert("reloadNode:" + path)
        }

        function lockNode(el) {
            const path = getPath(el)
            alert("lockNode:" + path)
        }

        function toggleFolder(el) {
            const path = getPath(el)
            if (folders[path].expanded) {
                folders[path].expanded = false
            } else {
                folders[path].expanded = true
            }
            refreshView(filez, folders, filesFilter)
        }

        function toggleFolderFilter(el) {
            const path = getPath(el)
            const filter = document.getElementById("filePathFilter")
            if (filter.value == path) {
                filter.value = ""
            } else {
                filter.value = path
            }
            onFilterPathChange(filter.value)
        }

        // TODO: colorize files and folders depending on their state like VSCode does

        function populate(table, filez, folders) {
            const foldersList = []
            for (const [filePath, value] of Object.entries(filez)) {
                value.path = filePath
                value.id = "file-" + filePath
                value.visible = true

                let folderPath = filePath.split('/').slice(0, -1).join('/')
                let folder = null
                if (folders[folderPath] === undefined) {
                    folders[folderPath] = { "path": folderPath, "id": "folder-" + folderPath,
                        "filez": {}, "folders": {}, "folder": null, visible: true, "expanded": false
                    }
                    if (folderPath == "") {
                        folders[folderPath].expanded = true
                    }
                    foldersList.push(folderPath)
                    folder = folders[folderPath]
                    // Add folder row
                    if (folderPath != "") {
                        let folderRow = table.insertRow()
                        folder.row = folderRow
                        folderRow.setAttribute("data-folder", "true")
                        folderRow.setAttribute("data-path", folderPath)
                        folderRow.classList.add("shown")
                        folderRow.id = folder.id + "-row"
                        let cell = null

                        cell = folderRow.insertCell()
                        cell.innerHTML = '<button id="' + folder.id + '-icon" title="Collapse/Expand" class="tool-icon f-white tool-icon-folder" onclick="toggleFolder(this)"></button>'

                        cell = folderRow.insertCell()
                        cell.innerHTML = '<button id="' + folder.id + '-main" title="Toggle path filter" class="tool b-t tool-status-color" onclick="toggleFolderFilter(this)">' + folderPath + '</button>'

                        cell = folderRow.insertCell()
                        cell.innerHTML = '<button id="' + folder.id + '-status" title="Status" class="tool tool-f-status tool-status-color""></button>'

                        cell = folderRow.insertCell()
                        cell.id = folder.id + "-nodeOps"
                        cell.innerHTML = "<span class='node-info'>\
<button class='tool tool-f-added'>A</button>\
<button class='tool tool-f-modified'>M</button>\
<button class='tool tool-f-renamed'>R</button>\
<button class='tool tool-f-removed'>D</button>\
</span>\
<span id=" + value.id + "-toolbox class='toolbox'>" + '\
<button id=' + value.id + '"-add"     class="tool-icon x-add     " title="Add"              onclick="addNode(this)">&#128932;</button>\
<button id=' + value.id + '"-delete"  class="tool-icon x-delete  " title="Remove Folder"    onclick="deleteNode(this)">&#10005;</button>\
<button id=' + value.id + '"-rename"  class="tool-icon x-rename  " title="Move/Rename"      onclick="renameNode(this)">&#128393;</button>\
<button id=' + value.id + '"-save"    class="tool-icon x-save    " title="Save changes"     onclick="saveChanges(this)">&#128427;</button>\
<button id=' + value.id + '"-reset"   class="tool-icon x-reset   " title="Reset changes"    onclick="resetChanges(this)"></button>\
<button id=' + value.id + '"-lock"    class="tool-icon x-lock    " title="Lock"             onclick="lockNode(this)">&#9919;</button>\
' + "</span>"

                        cell = folderRow.insertCell()
                        cell.id = folder.id + "-actions"
                        cell.innerHTML = ""         // TODO: add file / lock all / open-close all / save all / reset all changes / stash all / clone dir / remove dir

                        cell = folderRow.insertCell()
                        cell.id = folder.id + folderPath + "-state"
                        cell.innerHTML = ""         // TODO: cumulative state for files in the folder

                        cell = folderRow.insertCell()
                        cell.id = folder.id + folderPath + "-link"
                        cell.innerHTML = ""
                    }
                } else {
                    folder = folders[folderPath]
                }

                value.folder = folder
                folder.filez[filePath] = value

                // Add file row
                let fileRow = table.insertRow()
                value.row = fileRow
                fileRow.setAttribute("data-file", "true")
                fileRow.setAttribute("data-path", filePath)
                fileRow.classList.add("shown")
                fileRow.id = value.id + "-row"
                let cell = null

                cell = fileRow.insertCell()
                cell.innerHTML = '<button id="' + value.id + '-icon" title="Focus Tab" class="tool-icon f-white tool-icon-file" onclick="focusTab(this)"></button>'

                cell = fileRow.insertCell()
                cell.innerHTML = '<button id="' + value.id + '-main" title="Toggle Tab" class="tool b-t tool-text tool-status-color" onclick="toggleTab(this)">' + filePath + '</button>'

                cell = fileRow.insertCell()
                cell.innerHTML = '<button id="' + value.id + '-status" title="Status" class="tool tool-status tool-status-color""></button>'

                cell = fileRow.insertCell()
                cell.id = value.id + "-nodeOps"
                cell.innerHTML = "<span class='node-info f-greyed'>" + new Date(value.timestamp).toLocaleString() + "</span>\
<span id=" + value.id + "-toolbox class='toolbox'>" + '\
<button id=' + value.id + '"-add"     class="tool-icon x-add     " title="Add"              onclick="addNode(this)">&#128932;</button>\
<button id=' + value.id + '"-delete"  class="tool-icon x-delete  " title="Remove"           onclick="deleteNode(this)">&#10005;</button>\
<button id=' + value.id + '"-rename"  class="tool-icon x-rename  " title="Move/Rename"      onclick="renameNode(this)">&#128393;</button>\
<button id=' + value.id + '"-save"    class="tool-icon x-save    " title="Save changes"     onclick="saveChanges(this)">&#128427;</button>\
<button id=' + value.id + '"-reset"   class="tool-icon x-reset   " title="Reset changes"    onclick="resetChanges(this)"></button>\
<button id=' + value.id + '"-lock"    class="tool-icon x-lock    " title="Lock"             onclick="lockNode(this)">&#9919;</button>\
' + "</span>"

                cell = fileRow.insertCell()
                cell.id = value.id + "-actions"
                cell.innerHTML = ""  // TODO: actions section - lock / open-close / save / reset changes / stash changes / clone / remove

                cell = fileRow.insertCell()
                cell.id = value.id + folderPath + "-state"
                cell.innerHTML = ""  // TODO: state section - errors, remote changed

                cell = fileRow.insertCell()
                cell.id = value.id + folderPath + "-link"
                cell.innerHTML = ""  // TODO: link button
            }

            // After all folders are populated it's time to link subfolders to their parents
            foldersList.forEach(folderPath => {
                let parentPath = folderPath
                while (parentPath.length > 0) {
                    parentPath = parentPath.split('/').slice(0, -1).join('/')
                    if (folders[parentPath] == undefined) {
                        continue
                    }
                    folders[folderPath].folder = folders[parentPath]
                    folders[parentPath].folders[folderPath] = folders[folderPath]
                    break
                }
            })
        }

        function parentIsCollapsed(node, filters) {
            if (node.folder == null) {
                return false;
            } else {
                if (filters.path == node.folder.path || (filters.path.length > 0 && filters.path[0] != "/")) {
                    return false;
                } else if (!node.folder.expanded) {
                    return true;
                } else {
                    return parentIsCollapsed(node.folder, filters)
                }
            }
        }

        const fileStatus = ["outdate", "flocked", "locked", "added", "modified", "removed", "renamed",]
        const fileStatusChanged = ["added", "modified", "removed", "renamed",]

        function updateAttributes(filez, folders) {
            // Reset then update folder statuses
            for (const [folderPath, value] of Object.entries(folders)) {
                value.attributes = { "status": {}, "folder-expanded": "true", "fav": "false", "errors": [] }
                // Apply expanded property only, other are defined by files
                if (!value.expanded) {
                    value.attributes["folder-expanded"] = "false"
                }
            }
            // Reset then update files statuses and statuses of their folders
            for (const [filePath, value] of Object.entries(filez)) {
                value.attributes = { "status": {}, "file-open": "false", "fav": "false", "errors": "" }
                if (value.open) {
                    value.attributes["file-open"] = "true"
                }
                if (value.fav) {
                    value.attributes.fav = "true"
                    value.folder.attributes.fav = "true"
                }
                fileStatus.forEach(stat => {
                    if (value[stat]) {
                        value.attributes.status[stat] = true
                        value.folder.attributes.status[stat] = true
                        if (fileStatusChanged.indexOf(stat) >= 0) {
                            value.attributes.status["changes"] = true
                            value.folder.attributes.status["changes"] = true
                        }
                    }
                })
                if (value.errors !== undefined && value.errors !== null && value.errors.length > 0) {
                    value.attributes.status["errors"] = true
                    value.folder.attributes.status["errors"] = true
                    value.attributes.errors = value.errors
                    value.folder.attributes.errors.push(filePath)
                }
            }
            // Propagate folder's statuses to parents
            // Start from leaf folders
            let currentFolders = []
            for (const [folderPath, value] of Object.entries(folders)) {
                if ((Object.keys(value.folders)).length > 0) {
                    // skip non leaf folders
                    continue
                }
                currentFolders.push(value)
            }
            // Walk up to the root aggregating stats along the way
            while (currentFolders.length > 0) {
                let parentFolders = []
                currentFolders.forEach(current => {
                    let parent = current.folder
                    if (parent !== undefined && parent !== null) {

                        fileStatus.forEach(stat => {
                            if (current.attributes.status[stat]) {
                                parent.attributes.status[stat] = true
                            }
                        })
                        if (current.attributes.fav == "true") {
                            if (parent.attributes.fav == "false") {
                                parent.attributes.fav = "nested"
                            }
                        }
                        if (current.attributes.errors.length > 0) {
                            parent.attributes.errors = parent.attributes.errors.concat(current.attributes.errors)
                        }
                        parentFolders.push(current.folder)
                    }
                })
                currentFolders = parentFolders
            }
        }

        function applyAttributes(node) {
            if (node.row === undefined && node.row === null) {
                return
            }
            if (node.attributes !== undefined) {
                for (const [attr, value] of Object.entries(node.attributes)) {
                    if (attr == "status") {
                        node.row.setAttribute("data-status", Object.keys(value).join(" "))
                    } else if (attr == "errors") {
                        if (value.len > 0) {
                            node.row.setAttribute("data-errors", "true")
                        }
                    } else {
                        node.row.setAttribute("data-" + attr, value)
                    }
                }
            }
        }

        function refreshView(filez, folders, filters) {
            updateAttributes(filez, folders)
            for (const [filePath, value] of Object.entries(filez)) {
                if (!value.visible || !value.folder.visible || parentIsCollapsed(value, filters)) {
                    value.row.classList.add("hidden")
                    value.row.classList.remove("shown")
                } else {
                    value.row.classList.add("shown")
                    value.row.classList.remove("hidden")
                    applyAttributes(value)
                }
            }
            for (const [folderPath, value] of Object.entries(folders)) {
                if (value.row !== undefined) {
                    if ((!value.visible || parentIsCollapsed(value, filters)) && filters.path != value.path) {
                        value.row.classList.add("hidden")
                        value.row.classList.remove("shown")
                    } else {
                        value.row.classList.add("shown")
                        value.row.classList.remove("hidden")
                        applyAttributes(value)
                    }
                }
            }
        }

        const PathStartsWidth = 0
        const PathContains = 1
        const PathAny = -1

        function pathMatch(matchType, path, pattern) {
            return matchType == PathAny
                || (matchType == PathStartsWidth && path.startsWith(pattern.substring(1)))
                || (matchType == PathContains && path.search(pattern) >= 0)
        }

        function updateFilter(filez, folders, filter) {
            if (true) {
                const matchType = filter.path === undefined || filter.path === "" ? PathAny :
                    filter.path[0] == "^" ? PathStartsWidth : PathContains
                for (const [filePath, value] of Object.entries(filez)) {
                    value.visible = pathMatch(matchType, filePath, filter.path)
                }
                for (const [folderPath, value] of Object.entries(folders)) {
                    value.visible = false
                    for (const [filePath, fileValue] of Object.entries(value.filez)) {
                        if (fileValue.visible) {
                            value.visible = true
                            break
                        }
                    }
                }
            }

            refreshView(filez, folders, filter)
        }

        function onFilterPathChange(value) {
            filesFilter.path = value
            updateFilter(filez, folders, filesFilter)
        }

        function createOption(selector, text, value) {
            let opt = document.createElement("option");
            opt.value = value;
            opt.text = text;
            selector.options.add(opt);
        }
    </script>

    <div id="domainsSelector">
        Data domain: <select id="domains" class="tool" onchange="console.log(this.value)"></select>
    </div>

    <div id="filesBrowserPlaceholder">
        <table class="tool" id="filesBrowser">
            <thead>
                <tr>
                    <th>Extra</th>
                    <th colspan="2">File path</th>
                    <th>Last changed</th>
                    <th></th>
                    <th></th>
                    <th>Link</th>
                </tr>
                <tr>
                    <th> + / - </th>
                    <th><input id="filePathFilter" class="tool" value="" onchange="onFilterPathChange(this.value)"
                            onkeyup="onFilterPathChange(this.value)"
                            onkeypress="if (event.keyCode == 13) {return false}"></input> </th>
                    <th>&#9679;</th>
                    <th>Sort</th>
                    <th>&#9733;</th>
                    <th>&#9888;</th>
                    <th><select id="viewer" class="tool" onchange="console.log(this.value)">
                            <option>HDELK</option>
                            <option>D3HW</option>
                        </select> </th>
                </tr>
            </thead>
            <tbody id="filesList">
            </tbody>
        </table>
    </div>

    <script>
        ["demo", "test"].forEach(item => {
            createOption(document.getElementById("domains"), item, item)
        })

        document.getElementById("domains").value = "test"

        populate(document.getElementById("filesBrowser"), filez, folders)
        updateFilter(filez, folders, filesFilter)
    </script>

</body>

</html>
