<!DOCTYPE html>
<!-- resizables are based on https://htmldom.dev/create-resizable-split-views/ and https://github.com/1milligram/html-dom/blob/master/public/demo/create-resizable-split-views/index.html -->
<!-- tabs are based on https://alvarotrigo.com/blog/html-css-tabs/ and https://codepen.io/alvarotrigo/pen/qBPzgLg -->
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Yaml4Schm Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/monaco/assets/controller.js"></script>
    <script src="/monaco/assets/localdata.js"></script>
    <script src="/monaco/assets/servertalk.js"></script>
    <script src="/monaco/assets/remotefiles.js"></script>
    <script src="/monaco/assets/remotedata.js"></script>
    <link href="/monaco/assets/container.css" rel="stylesheet">
    <link href="/monaco/assets/popup.css" rel="stylesheet">
</head>

<!-- TODO: may be replace with https://github.com/bootrino/reactoxide already -->

<body>
    <script>
        const serverDomain = "http://127.0.0.1:8089";   // TODO: It's UGLY, do better
        const iframeDomain = "http://127.0.0.1:8089";   // TODO: It's UGLY, do better
        const timestamp = new Date().getTime();         // NOTE: set to const when done with iframes. Currently fresh timestamp is required to avoid iframes caching.

        const server = new ServerTalk(serverDomain);    // Provides IO with server
        const remoteFiles = new RemoteFiles(server);    // Abstraction above IO to operate with files

        // Controller provides glue layer between UI items and storage, implements complex operations
        const controller = new Controller(iframeDomain, iframeDomain, remoteFiles, null, null);

        // Local storage data access
        let localData = null;

        // Remote storage data access
        let remoteData = null;

        // Current domain
        let domain = null
        // TODO: show dialog to select domain and load local data exactly for selected domain

        function switchDomain(new_domain) {
            return new Promise((resolve, reject) => { resolve(true) })
                .then(() => {
                    let _localData = new LocalData(new_domain);
                    let _remoteData = new RemoteData(remoteFiles, new_domain);
                    return _localData.ifCreated
                        .then(_ => _remoteData.ifCreated)
                        .then(_ => {
                            localData = _localData;
                            remoteData = _remoteData;
                            localData.remoteData = _remoteData;
                            _localData.remoteFiles = remoteFiles;
                        })
                        .then(_ => controller.attachData(remoteData, localData))
                        .then(_ => setCurrentDomain(new_domain))
                        .then(_ => domain = new_domain)
                    // TODO: reaction on error
                })
        }

        getCurrentDomain().then(
            (value) => switchDomain(value),
            (err) => switchDomain("demo")
        )

        function reloadIframes() {
            // Load iframes (NOTE: timestamp is used to avoid caching. In production timestamp is set to a const)
            const browser_url = iframeDomain + "/monaco/assets/file_selector.html" + "?timestamp=" + timestamp;
            document.getElementById("browser").src = browser_url;

            const editor_url = iframeDomain + "/monaco/index.html" + "?timestamp=" + timestamp;
            document.getElementById("editor").src = editor_url;

            const preview_url = iframeDomain + "/d3hw/show/data/sketch.yaml" + "?timestamp=" + timestamp;
            document.getElementById("preview").src = preview_url;
        }

        // Inter-iframe communications
        const callbackHandler = function (callback, retArgs) {
            if (!Array.isArray(retArgs)) {
                retArgs = [retArgs]
            }
            event.source.postMessage({
                'func': callback.func,
                'obj': callback.obj,
                'method': callback.method,
                'args': retArgs,
                'callback': undefined,
            }, callback.origin);
        }

        window.addEventListener('message', (event) => {
            console.log("Container received message: " + JSON.stringify(event), "\n origin - " + JSON.stringify(event.origin), "\n data   - " + JSON.stringify(event.data));
            if (event.origin !== iframeDomain) {
                return null;
            }
            if (event.data.func === 'call') {
                if (event.data.obj === undefined) {
                    return null;
                }
                if (event.data.method === undefined) {
                    return null;
                }
                if (event.data.args === undefined) {
                    return null;
                }
                if (event.data.obj !== undefined) {
                    let obj = null;
                    if (event.data.obj === 'controller') {
                        obj = controller;
                    } else if (event.data.obj === 'localData') {
                        obj = localData;
                    }
                    if (obj == null) {
                        return null;
                    }
                    if (obj[event.data.method] !== undefined) {
                        let result = obj[event.data.method](...event.data.args);
                        if (event.data.callback !== undefined) {
                            if (result instanceof Promise) {
                                result.then(retArgs => callbackHandler(event.data.callback, retArgs))
                            } else {
                                callbackHandler(event.data.callback, result)
                            }
                        }
                    }
                } else {
                    return null;
                }
            }
        });

    </script>

    <!--
    <div class="container">
        <div class="container__left">
            <div class="container__tl">Top Left</div>
            <div class="resizer" data-direction="vertical"></div>
            <div class="container__bl">Bottom Left</div>
        </div>
        <div class="resizer" data-direction="horizontal"></div>
        <div class="container__right">
            <div class="container__tr">Top Right</div>
            <div class="resizer" data-direction="vertical"></div>
            <div class="container__br">Bottom Right</div>
        </div>
    </div>
    -->

    <!-- PopUp for modal dialogs -->
    <div class="hover_bkgr_fricc">
        <span class="helper"></span>
        <div>
            <div class="popupCloseButton">&times;</div>
            <p>Add any HTML content<br />inside the popup box!</p>
        </div>
    </div>

    <!-- Main layout (containers) -->
    <div class="container">
        <!-- File Browser -->
        <div class="container__left">
            <iframe class="container__bl" name="browser" id="browser" width="100%" scrolling="no"></iframe>
            <!-- <div class="container__bl" with="100%">Browser</div> -->
        </div>
        <div class="resizer" data-direction="horizontal"></div>
        <!-- Editor -->
        <div class="container__middle">
            <iframe class="container__bm" name="editor" id="editor" width="100%"></iframe>
            <!-- <div class="container__bm" with="100%">Editor</div> -->
        </div>
        <div class="resizer" data-direction="horizontal"></div>
        <div class="container__right">
            <!-- Preview selector -->
            <div class="container__tr" with="100%" style="color: #ddd">Diagram picker</div>
            <!-- Preview itself -->
            <iframe class="container__br" name="preview" id="preview" width="100%"
                style="filter: invert(100%) hue-rotate(180deg)"></iframe>
            <!-- <div class="container__br" with="100%">Diagram</div> -->
        </div>
    </div>

    <script>
        // Do once as windows loaded
        document.addEventListener('DOMContentLoaded', function () {
            reloadIframes();

            // Config resizable things
            const resizable = function (resizer) {
                const direction = resizer.getAttribute('data-direction') || 'horizontal';
                const prevSibling = resizer.previousElementSibling;
                const nextSibling = resizer.nextElementSibling;

                // The current position of mouse
                let x = 0;
                let y = 0;
                let prevSiblingHeight = 0;
                let prevSiblingWidth = 0;

                // Handle the mousedown event
                // that's triggered when user drags the resizer
                const mouseDownHandler = function (e) {
                    // Get the current mouse position
                    x = e.clientX;
                    y = e.clientY;
                    const rect = prevSibling.getBoundingClientRect();
                    prevSiblingHeight = rect.height;
                    prevSiblingWidth = rect.width;

                    // Attach the listeners to `document`
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                };

                const mouseMoveHandler = function (e) {
                    // How far the mouse has been moved
                    const dx = e.clientX - x;
                    const dy = e.clientY - y;

                    switch (direction) {
                        case 'vertical':
                            const h =
                                ((prevSiblingHeight + dy) * 100) /
                                resizer.parentNode.getBoundingClientRect().height;
                            prevSibling.style.height = `${h}%`;
                            break;
                        case 'horizontal':
                        default:
                            const w =
                                ((prevSiblingWidth + dx) * 100) / resizer.parentNode.getBoundingClientRect().width;
                            prevSibling.style.width = `${w}%`;
                            break;
                    }

                    const cursor = direction === 'horizontal' ? 'col-resize' : 'row-resize';
                    resizer.style.cursor = cursor;
                    document.body.style.cursor = cursor;

                    prevSibling.style.userSelect = 'none';
                    prevSibling.style.pointerEvents = 'none';

                    nextSibling.style.userSelect = 'none';
                    nextSibling.style.pointerEvents = 'none';
                };

                const mouseUpHandler = function () {
                    resizer.style.removeProperty('cursor');
                    document.body.style.removeProperty('cursor');

                    prevSibling.style.removeProperty('user-select');
                    prevSibling.style.removeProperty('pointer-events');

                    nextSibling.style.removeProperty('user-select');
                    nextSibling.style.removeProperty('pointer-events');

                    // Remove the handlers of `mousemove` and `mouseup`
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                };

                // Attach the handler
                resizer.addEventListener('mousedown', mouseDownHandler);
            };

            // Query all resizers
            document.querySelectorAll('.resizer').forEach(function (ele) {
                resizable(ele);
            });
        });
    </script>

    <!-- TODO: use following for modal dialogs
    <a class="trigger_popup_fricc">Click here to show the popup</a>
    <script>
        // Setup popup actions
        $(window).load(function () {
            $(".trigger_popup_fricc").click(function () {
                $('.hover_bkgr_fricc').show();
                console.log("Show popup");
            });
            /*
            $('.hover_bkgr_fricc').click(function(){
                $('.hover_bkgr_fricc').hide();
            });
            */
            $('.popupCloseButton').click(function () {
                $('.hover_bkgr_fricc').hide();
                console.log("Close popup");
            });
        });
    </script>
    -->

</body>

</html>
